# protoc-gen-seaorm

A protoc plugin that generates [SeaORM](https://www.sea-ql.org/SeaORM/) 2.0 entity models from Protocol Buffer definitions.

## Features

- Generate SeaORM 2.0 entities from protobuf messages
- Support for all relation types: `has_one`, `has_many`, `belongs_to`, `many_to_many`
- Automatic type mapping from protobuf to Rust/SeaORM types
- Custom field options for primary keys, unique constraints, nullable fields
- Enum generation with string or integer database storage
- Embedded JSON fields for nested messages
- Oneof field handling with multiple strategies

## Installation

### From source

```bash
cargo install --path .
```

### Build locally

```bash
cargo build --release
# Binary will be at ./target/release/protoc-gen-seaorm
```

## Usage with Buf

### 1. Add the options proto to your project

Copy `proto/seaorm/options.proto` to your project, or add it as a buf dependency (coming soon).

### 2. Configure buf.yaml

```yaml
version: v2
modules:
  - path: proto
deps:
  - buf.build/protocolbuffers/wellknowntypes
```

### 3. Configure buf.gen.yaml

```yaml
version: v2
plugins:
  - local: path/to/protoc-gen-seaorm
    out: src/entity
    opt:
      - retain_options=true
```

### 4. Define your proto with SeaORM options

```protobuf
syntax = "proto3";
package example;

import "seaorm/options.proto";
import "google/protobuf/timestamp.proto";

message User {
  option (seaorm.model) = {
    table_name: "users"
    relations: [
      {name: "posts", type: RELATION_TYPE_HAS_MANY, related: "post", foreign_key: "author_id"}
    ]
  };

  int64 id = 1 [(seaorm.column) = { primary_key: true, auto_increment: true }];
  string email = 2 [(seaorm.column).unique = true];
  string name = 3;
  google.protobuf.Timestamp created_at = 4;
}

message Post {
  option (seaorm.model) = {
    table_name: "posts"
    relations: [
      {name: "author", type: RELATION_TYPE_BELONGS_TO, related: "user", foreign_key: "author_id"}
    ]
  };

  int64 id = 1 [(seaorm.column) = { primary_key: true, auto_increment: true }];
  string title = 2;
  string content = 3;
  int64 author_id = 4;
  google.protobuf.Timestamp created_at = 5;
}
```

### 5. Generate entities

```bash
buf generate
```

### Generated output

```rust
//! Generated by protoc-gen-seaorm from protobuf definition.
use sea_orm::entity::prelude::*;

#[sea_orm::model]
#[derive(Clone, Debug, PartialEq, Eq, DeriveEntityModel)]
#[sea_orm(table_name = "users")]
pub struct Model {
    #[sea_orm(primary_key)]
    pub id: i64,
    #[sea_orm(unique)]
    pub email: String,
    pub name: String,
    pub created_at: DateTimeUtc,
    #[sea_orm(has_many)]
    pub posts: HasMany<super::post::Entity>,
}

impl ActiveModelBehavior for ActiveModel {}
```

## Options Reference

### Message Options (`seaorm.model`)

| Option | Type | Description |
|--------|------|-------------|
| `table_name` | string | Database table name (defaults to snake_case of message name) |
| `skip` | bool | Skip generation for this message |
| `relations` | repeated RelationDef | Define entity relations |
| `indexes` | repeated string | Index definitions |

### Column Options (`seaorm.column`)

| Option | Type | Description |
|--------|------|-------------|
| `primary_key` | bool | Mark as primary key |
| `auto_increment` | bool | Enable auto-increment |
| `unique` | bool | Add unique constraint |
| `nullable` | bool | Mark as nullable |
| `column_name` | string | Override column name |
| `column_type` | string | Override SeaORM column type |
| `default_value` | string | Default literal value (e.g., `"0"`, `"false"`) |
| `default_expr` | string | Default expression (e.g., `"Expr::current_timestamp()"`) |
| `embed` | bool | Store as JSON (for nested messages) |

### Relation Definition

| Field | Type | Description |
|-------|------|-------------|
| `name` | string | Relation field name |
| `type` | RelationType | `BELONGS_TO`, `HAS_ONE`, `HAS_MANY`, `MANY_TO_MANY` |
| `related` | string | Related entity name |
| `foreign_key` | string | Foreign key column |
| `references` | string | Referenced column (defaults to "id") |
| `through` | string | Junction table for many-to-many |

### Enum Options (`seaorm.enum_opt`)

| Option | Type | Description |
|--------|------|-------------|
| `name` | string | Override Rust enum name |
| `db_type` | string | `"string"` (default) or `"integer"` |
| `skip` | bool | Skip generation |

## Type Mappings

| Protobuf Type | Rust Type |
|---------------|-----------|
| `int32` | `i32` |
| `int64` | `i64` |
| `uint32` | `u32` |
| `uint64` | `u64` |
| `float` | `f32` |
| `double` | `f64` |
| `bool` | `bool` |
| `string` | `String` |
| `bytes` | `Vec<u8>` |
| `google.protobuf.Timestamp` | `DateTimeUtc` |

## Example

See the [examples/database](./examples/database) directory for a complete working example with:

- Proto definitions with relations
- Generated entities
- Database tests using SeaORM 2.0's schema-sync
- Builder pattern usage

```bash
cd examples/database
buf generate
cargo test
cargo run
```

## Development

### Prerequisites

- Rust 1.70+
- [buf](https://buf.build/docs/installation)
- [just](https://github.com/casey/just) (optional, for task running)

### Commands

```bash
just fmt      # Format code
just lint     # Run clippy
just test     # Run all tests
just ci       # Run all CI checks
just example  # Build and run the example
```

## License

MIT
